---
title: "Experimental Features"
description: |
A new article created using the Radix format.
author:
  - name: Nora Jones 
    url: https://example.com/norajones
    affiliation: Spacely Sprockets
    affiliation_url: https://example.com/spacelysprokets
date: "`r Sys.Date()`"
output: radix::radix_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

## Data

### database connection

```{r}
# packages
library(tidyverse)
library(umap)
library(plotly)

theme_set(theme_classic())

# con
con = DBI::dbConnect(RSQLite::SQLite(), "database/Sqlite.db")

# queries
sqlQueryMeta <- paste("SELECT * FROM id_info")
sqlQueryData <- function(dataset_ID){
  query <- paste0("SELECT * FROM data2 WHERE ID IN (", paste(dataset_ID, collapse = ","), ")")
  return(query)
}

# table 
DBI::dbListTables(con)

# data
meta <- collect(tbl(database_connection, sql(sqlQueryMeta))) %>% 
  mutate(id = factor(id))
meta$id
query <- sqlQueryData(meta$id)
raw <- collect(tbl(database_connection, sql(sqlQueryData(meta$id))))

dbDisconnect(con)
```

### Data processing

```{r}
class_levels <- c("PC", "PC O-", "LPC", "PE", "PE O-", "PE P-", "LPE", "PS",
                  "PS O-", "PI", "PI O-", "PG", "PG O-", "LPG", "PA", "PA O-",
                  "LPA", "CL", "MLCL", "Cer", "SM", "HexCer", "SGalCer", "GM3",
                  "Sulf", "diHexCer", "Hex2Cer", "For", "IPC", "MIPC", "M(IP)2C",
                  "Chol", "Desm", "Erg", "CE", "EE", "DAG", "TAG", "PIP", "PIP2",
                  "PIP3", "GM1Cer", "GD1Cer", "MAG", "Epi", "PGP", "WE", "FA")

mainData <-
  raw %>%
  filter(!is.na(value)) %>% 
  mutate(
    id = factor(id),
    sample_identifier = factor(sample_identifier),
    lipid = factor(lipid),
    func_cat = factor(func_cat),
    class = forcats::fct_relevel(class, class_levels),
    category = factor(category),
    sample = factor(sample),
    sample_replicate = factor(sample_replicate),
    sample_replicate_technical = factor(sample_replicate_technical),
    oh = if_else(is.na(oh), 0, oh)
  ) %>%
  select(id, sample_identifier, lipid, value, everything())
mainData
```

```{r}
mainData <-
  mainData %>%
  group_by(id, sample_replicate_technical) %>%
  mutate(value = value / sum(value) * 100) %>%
  ungroup()
mainData
```

```{r}
mainData <- 
  mainData %>% 
  unite(sam, id, sample_identifier, sep = "_", remove = FALSE)
```

## UMAP

This is the implementation of a farily new algorithm called UMAP, explainded in
this [paper](https://arxiv.org/abs/1802.03426):  
UMAP: Uniform Manifold Approximation and Projection for
Dimension Reduction &#8211 Leland McInnes, John Healy

```{r}
umap_wide <- 
  mainData %>%
  select(sam, lipid, value) %>%
  spread(lipid, value) %>%
  replace(is.na(.), 0)

umap_data <- 
  umap_wide %>%
  select(-sam) %>%
  as.data.frame()

umap_labels <-
  umap_wide %>% select(sam)

umap_samples <- 
  mainData %>%
  select(sam, id, sample) %>%
  distinct()

umap_model <- 
  umap::umap(umap_data)

umap_annotated <- 
  umap_model$layout %>%
  as_tibble() %>%
  bind_cols(umap_labels) %>%
  inner_join(umap_samples) %>% 
  inner_join(select(meta, id, title))

umap_plt <-
  umap_annotated %>%
  ggplot(aes(V1, V2, color = id, label = paste(sample, title))) +
  geom_point()

umap_plt
# ggplotly(umap_plt)

umap_model
```



```{r}
custom.settings = umap.defaults
custom.settings$n_epochs = 400
custom.settings$n_neighbors = 20
custom.settings$random_state = 2018

umap_model_tweaked <- 
  umap(umap_data, config = custom.settings)

umap_annotated <- 
  umap_model$layout %>%
  as_tibble() %>%
  bind_cols(umap_labels) %>%
  inner_join(umap_samples) %>% 
  inner_join(select(meta, id, title))

plt_tweaked <-
  umap_annotated %>%
  ggplot(aes(V1, V2, color = id, label = paste(sample, title))) +
  geom_point()+
  scale_color_brewer(palette = "Set1")

plt_tweaked
```

#### Proof of concept for UMAP

with a for dimensional space of colors

```{r}
data <- data.frame(
  id = 1:200,
  r = sample(0:255, 200, replace = T),
  g = sample(0:255, 200, replace = T),
  b = sample(0:255, 200, replace = T),
  a = sample(0:255, 200, replace = T)
)
data

for (n in c(2,5,15,50,200)){
  model <- umap(data[2:5], n_neighbors = n)
  annotated <-
    model$layout %>%
    as_tibble() %>%
    bind_cols(data)
  
  data_colors <- map_chr(1:200, ~rgb(data[.,1], data[.,2], data[.,3], data[.,4], maxColorValue = 255))
  plot(annotated$V1, annotated$V2, col = data_colors, pch = 19, cex = 2)
  title(paste("N of neighbors:", n))
}
```

